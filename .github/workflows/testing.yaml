---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: "Test gerrit_json Generation ðŸ§ª"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  repository-metadata:
    name: "Repository Metadata"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    timeout-minutes: 5
    steps:
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2  # v2.13.2
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0

      - name: "Gather repository metadata"
        id: repo-metadata
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/repository-metadata-action@5fd432a3a4593f838a8a51e39be81c9afb250e0b  # v0.1.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          generate_summary: 'false'
          artifact_upload: 'true'
          artifact_formats: 'json'

  ### Test gerrit_json generation ###
  test-json-generation:
    name: "Test gerrit_json generation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    outputs:
      gerrit_json: ${{ steps.generate.outputs.gerrit_json }}
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Setup Python"
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: "Install package"
        shell: bash
        run: |
          echo "Installing gerrit_to_platform package..."
          pip install -e .
          echo "âœ“ Package installed"

      - name: "Generate gerrit_json from test data"
        id: generate
        shell: bash
        run: |
          echo "Generating gerrit_json using build_gerrit_json()..."

          # Use Python to generate the JSON
          GERRIT_JSON=$(python3 << 'EOF'
          from gerrit_to_platform.helpers import build_gerrit_json

          # Simulate a patchset-created event
          inputs = {
              'GERRIT_BRANCH': 'main',
              'GERRIT_CHANGE_ID': 'I1234567890abcdef1234567890abcdef12345678',
              'GERRIT_CHANGE_NUMBER': '12345',
              'GERRIT_CHANGE_URL': 'https://gerrit.example.com/r/c/test-project/+/12345',
              'GERRIT_EVENT_TYPE': 'patchset-created',
              'GERRIT_PATCHSET_NUMBER': '3',
              'GERRIT_PATCHSET_REVISION': 'abcdef1234567890abcdef1234567890abcdef12',
              'GERRIT_PROJECT': 'test-project',
              'GERRIT_REFSPEC': 'refs/changes/45/12345/3'
          }

          print(build_gerrit_json(inputs))
          EOF
          )

          echo "Generated gerrit_json:"
          echo "$GERRIT_JSON" | jq '.'

          # Export to output (escape for GitHub Actions)
          echo "gerrit_json=$GERRIT_JSON" >> $GITHUB_OUTPUT

          echo "âœ“ gerrit_json generated successfully"

      - name: "Verify JSON structure"
        shell: bash
        run: |
          echo "Verifying generated JSON..."
          GERRIT_JSON='${{ steps.generate.outputs.gerrit_json }}'

          # Basic validation
          echo "$GERRIT_JSON" | jq empty

          # Check all required fields
          REQUIRED_FIELDS=("branch" "change_id" "change_number" "change_url" "event_type" "patchset_number" "patchset_revision" "project" "refspec")

          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! echo "$GERRIT_JSON" | jq -e ".$field" > /dev/null; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
            echo "âœ“ Field present: $field"
          done

          echo "âœ“ All required fields present"

      - name: "Display JSON summary"
        shell: bash
        run: |
          echo "## gerrit_json Generation Test" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Generated JSON:" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.generate.outputs.gerrit_json }}' | jq '.' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          SIZE=$(echo '${{ steps.generate.outputs.gerrit_json }}' | wc -c)
          echo "Size: $SIZE bytes" >> "$GITHUB_STEP_SUMMARY"

  ### Test Shell validation script ###
  test-shell-validation:
    name: "Test Shell validation (validate-json.sh)"
    needs: test-json-generation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Test validate-json.sh with valid JSON"
        shell: bash
        run: |
          echo "Testing validate-json.sh with generated gerrit_json..."
          chmod +x examples/validate-json.sh
          ./examples/validate-json.sh '${{ needs.test-json-generation.outputs.gerrit_json }}'
          echo "âœ“ Shell validation passed"

      - name: "Test validate-json.sh with invalid JSON (missing field)"
        shell: bash
        continue-on-error: true
        id: invalid-test
        run: |
          echo "Testing validation with missing required field..."
          ./examples/validate-json.sh '{"branch":"main","event_type":"patchset-created"}'

      - name: "Verify validation caught error"
        if: steps.invalid-test.outcome == 'success'
        shell: bash
        run: |
          echo "âŒ Validation should have failed for invalid JSON"
          exit 1

      - name: "Test validate-json.sh with invalid event_type"
        shell: bash
        continue-on-error: true
        id: invalid-event
        run: |
          echo "Testing validation with invalid event_type..."
          ./examples/validate-json.sh '{"branch":"main","change_id":"I123","change_number":"1","change_url":"url","event_type":"invalid-type","patchset_number":"1","patchset_revision":"abc","project":"proj","refspec":"ref"}'

      - name: "Verify event_type validation"
        if: steps.invalid-event.outcome == 'success'
        shell: bash
        run: |
          echo "âŒ Validation should have failed for invalid event_type"
          exit 1

      - name: "Shell validation summary"
        shell: bash
        run: |
          echo "## Shell Validation Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Valid JSON passed validation" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Invalid JSON correctly rejected" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Invalid event_type correctly rejected" >> "$GITHUB_STEP_SUMMARY"

  ### Test Python validation script ###
  test-python-validation:
    name: "Test Python validation (validate-json.py)"
    needs: test-json-generation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Setup Python"
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: "Test validate-json.py with valid JSON"
        shell: bash
        run: |
          echo "Testing validate-json.py with generated gerrit_json..."
          chmod +x examples/validate-json.py
          ./examples/validate-json.py '${{ needs.test-json-generation.outputs.gerrit_json }}'
          echo "âœ“ Python validation passed"

      - name: "Test validate-json.py with invalid JSON (missing field)"
        shell: bash
        continue-on-error: true
        id: invalid-test
        run: |
          echo "Testing validation with missing required field..."
          ./examples/validate-json.py '{"branch":"main","event_type":"patchset-created"}'

      - name: "Verify validation caught error"
        if: steps.invalid-test.outcome == 'success'
        shell: bash
        run: |
          echo "âŒ Validation should have failed for invalid JSON"
          exit 1

      - name: "Test validate-json.py with invalid event_type"
        shell: bash
        continue-on-error: true
        id: invalid-event
        run: |
          echo "Testing validation with invalid event_type..."
          ./examples/validate-json.py '{"branch":"main","change_id":"I123","change_number":"1","change_url":"url","event_type":"invalid-type","patchset_number":"1","patchset_revision":"abc","project":"proj","refspec":"ref"}'

      - name: "Verify event_type validation"
        if: steps.invalid-event.outcome == 'success'
        shell: bash
        run: |
          echo "âŒ Validation should have failed for invalid event_type"
          exit 1

      - name: "Test with comment field (comment-added event)"
        shell: bash
        run: |
          echo "Testing with optional comment field..."
          ./examples/validate-json.py '{"branch":"main","change_id":"I123","change_number":"1","change_url":"url","event_type":"comment-added","patchset_number":"1","patchset_revision":"abc","project":"proj","refspec":"ref","comment":"gha-run test"}'
          echo "âœ“ Comment field validation passed"

      - name: "Python validation summary"
        shell: bash
        run: |
          echo "## Python Validation Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Valid JSON passed validation" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Invalid JSON correctly rejected" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Invalid event_type correctly rejected" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Optional comment field validated" >> "$GITHUB_STEP_SUMMARY"

  ### Test downstream workflow consumption ###
  test-downstream-consumer:
    name: "Test as downstream workflow consumer"
    needs: test-json-generation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Parse gerrit_json as downstream consumer"
        id: parse
        shell: bash
        run: |
          echo "Parsing gerrit_json as a downstream workflow would..."
          GERRIT_JSON='${{ needs.test-json-generation.outputs.gerrit_json }}'

          # Extract fields using jq
          echo "branch=$(echo "$GERRIT_JSON" | jq -r '.branch')" >> $GITHUB_OUTPUT
          echo "change_number=$(echo "$GERRIT_JSON" | jq -r '.change_number')" >> $GITHUB_OUTPUT
          echo "change_id=$(echo "$GERRIT_JSON" | jq -r '.change_id')" >> $GITHUB_OUTPUT
          echo "event_type=$(echo "$GERRIT_JSON" | jq -r '.event_type')" >> $GITHUB_OUTPUT
          echo "refspec=$(echo "$GERRIT_JSON" | jq -r '.refspec')" >> $GITHUB_OUTPUT
          echo "project=$(echo "$GERRIT_JSON" | jq -r '.project')" >> $GITHUB_OUTPUT

          echo "âœ“ Successfully parsed all fields"

      - name: "Verify parsed values"
        shell: bash
        run: |
          echo "Parsed values:"
          echo "  Branch: ${{ steps.parse.outputs.branch }}"
          echo "  Change Number: ${{ steps.parse.outputs.change_number }}"
          echo "  Change ID: ${{ steps.parse.outputs.change_id }}"
          echo "  Event Type: ${{ steps.parse.outputs.event_type }}"
          echo "  Refspec: ${{ steps.parse.outputs.refspec }}"
          echo "  Project: ${{ steps.parse.outputs.project }}"

          # Verify expected values
          if [ "${{ steps.parse.outputs.branch }}" != "main" ]; then
            echo "âŒ Branch mismatch"
            exit 1
          fi

          if [ "${{ steps.parse.outputs.change_number }}" != "12345" ]; then
            echo "âŒ Change number mismatch"
            exit 1
          fi

          if [ "${{ steps.parse.outputs.event_type }}" != "patchset-created" ]; then
            echo "âŒ Event type mismatch"
            exit 1
          fi

          echo "âœ“ All parsed values match expected values"

      - name: "Simulate workflow actions using parsed data"
        shell: bash
        run: |
          echo "Simulating typical workflow actions..."
          echo "Would checkout branch: ${{ steps.parse.outputs.branch }}"
          echo "Would fetch refspec: ${{ steps.parse.outputs.refspec }}"
          echo "Would process change: ${{ steps.parse.outputs.change_number }}"
          echo "Event type: ${{ steps.parse.outputs.event_type }}"
          echo ""
          echo "âœ“ Successfully demonstrated downstream consumption"

      - name: "Downstream consumer summary"
        shell: bash
        run: |
          echo "## Downstream Consumer Test" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Successfully consumed gerrit_json as a downstream workflow:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | ${{ steps.parse.outputs.branch }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Change | ${{ steps.parse.outputs.change_number }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Event | ${{ steps.parse.outputs.event_type }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Project | ${{ steps.parse.outputs.project }} |" >> "$GITHUB_STEP_SUMMARY"

  ### Test multiple event types ###
  test-multiple-events:
    name: "Test all event types"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    strategy:
      matrix:
        event:
          - type: patchset-created
            has_comment: false
          - type: change-merged
            has_comment: false
          - type: comment-added
            has_comment: true
    steps:
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Setup Python"
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: "Install package"
        shell: bash
        run: pip install -e .

      - name: "Generate JSON for ${{ matrix.event.type }}"
        shell: bash
        run: |
          echo "Testing event type: ${{ matrix.event.type }}"

          GERRIT_JSON=$(python3 << 'EOF'
          from gerrit_to_platform.helpers import build_gerrit_json

          inputs = {
              'GERRIT_BRANCH': 'main',
              'GERRIT_CHANGE_ID': 'I1234567890abcdef1234567890abcdef12345678',
              'GERRIT_CHANGE_NUMBER': '12345',
              'GERRIT_CHANGE_URL': 'https://gerrit.example.com/r/c/test-project/+/12345',
              'GERRIT_EVENT_TYPE': '${{ matrix.event.type }}',
              'GERRIT_PATCHSET_NUMBER': '3',
              'GERRIT_PATCHSET_REVISION': 'abcdef1234567890abcdef1234567890abcdef12',
              'GERRIT_PROJECT': 'test-project',
              'GERRIT_REFSPEC': 'refs/changes/45/12345/3'
          }

          if '${{ matrix.event.has_comment }}' == 'true':
              inputs['GERRIT_COMMENT'] = 'gha-run test-workflow param=value'

          print(build_gerrit_json(inputs))
          EOF
          )

          echo "Generated JSON:"
          echo "$GERRIT_JSON" | jq '.'

          # Validate with both scripts
          echo "Validating with Shell script..."
          chmod +x examples/validate-json.sh
          ./examples/validate-json.sh "$GERRIT_JSON"

          echo "Validating with Python script..."
          chmod +x examples/validate-json.py
          ./examples/validate-json.py "$GERRIT_JSON"

          echo "âœ“ Event type ${{ matrix.event.type }} validated successfully"

  ### Final summary ###
  test-summary:
    name: "Test Summary"
    needs:
      - test-json-generation
      - test-shell-validation
      - test-python-validation
      - test-downstream-consumer
      - test-multiple-events
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: "Check test results"
        shell: bash
        run: |
          echo "## ðŸŽ‰ gerrit_json Testing Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Test Results:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… JSON Generation: ${{ needs.test-json-generation.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Shell Validation: ${{ needs.test-shell-validation.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Python Validation: ${{ needs.test-python-validation.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Downstream Consumer: ${{ needs.test-downstream-consumer.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Multiple Event Types: ${{ needs.test-multiple-events.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Key Features Tested:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "1. âœ… JSON generation from GERRIT_* variables" >> "$GITHUB_STEP_SUMMARY"
          echo "2. âœ… Shell script validation (validate-json.sh)" >> "$GITHUB_STEP_SUMMARY"
          echo "3. âœ… Python script validation (validate-json.py)" >> "$GITHUB_STEP_SUMMARY"
          echo "4. âœ… Downstream workflow consumption" >> "$GITHUB_STEP_SUMMARY"
          echo "5. âœ… All three event types (patchset-created, change-merged, comment-added)" >> "$GITHUB_STEP_SUMMARY"
          echo "6. âœ… Optional comment field handling" >> "$GITHUB_STEP_SUMMARY"
          echo "7. âœ… Invalid input rejection" >> "$GITHUB_STEP_SUMMARY"

          # Fail if any required job failed
          if [ "${{ needs.test-json-generation.result }}" != "success" ] || \
             [ "${{ needs.test-shell-validation.result }}" != "success" ] || \
             [ "${{ needs.test-python-validation.result }}" != "success" ] || \
             [ "${{ needs.test-downstream-consumer.result }}" != "success" ] || \
             [ "${{ needs.test-multiple-events.result }}" != "success" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âŒ Some tests failed. Please review the logs above." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… All tests passed successfully!" >> "$GITHUB_STEP_SUMMARY"
